{% load i18n %}
{% load tq_tags %}

<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item ms-3" role="presentation">
        <button class="nav-link active text-tanzquotient" id="table-courses-tab" data-bs-toggle="pill" data-bs-target="#table-courses"
                type="button" role="tab" aria-controls="table-courses" aria-selected="true">
            {% trans "Courses" %}
        </button>
    </li>
    <li class="nav-item ms-3" role="presentation">
        <button class="nav-link text-tanzquotient" id="table-teachers-tab" data-bs-toggle="pill" data-bs-target="#table-teachers"
                type="button" role="tab" aria-controls="table-teachers" aria-selected="false">
            {% trans "Teachers" %}
        </button>
    </li>
    <li class="nav-item ms-3" role="presentation">
        <button class="nav-link text-tanzquotient" id="table-teachings-tab" data-bs-toggle="pill" data-bs-target="#table-teachings"
                type="button" role="tab" aria-controls="table-teachings" aria-selected="false">
            {% trans "Teachings" %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-tanzquotient" id="table-personal-data-tab" data-bs-toggle="pill"
                data-bs-target="#table-personal-data" type="button" role="tab" aria-controls="table-personal-data"
                aria-selected="false">
            {% trans "Personal details" %}
        </button>
    </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade show active table-responsive" id="table-courses" role="tabpanel" aria-labelledby="table-courses-tab"
         tabindex="0">
        {% table courses %}
    </div>
    <div class="tab-pane fade table-responsive" id="table-teachers" role="tabpanel" aria-labelledby="table-teachers-tab"
         tabindex="0">
        {% table teachers %}
    </div>
    <div class="tab-pane fade table-responsive" id="table-teachings" role="tabpanel" aria-labelledby="table-teachings-tab"
         tabindex="0">
        {% table teachings %}
    </div>
    <div class="tab-pane fade table-responsive" id="table-personal-data" role="tabpanel" aria-labelledby="table-personal-data-tab"
         tabindex="0">
        {% table personal_data %}
    </div>
</div>

<div class="modal" tabindex="-1" id="confirmModal">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{% trans "Are you sure?" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>{% trans "Marking a course as completed will freeze its teachers presence form permanently." %}</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
          <button type="button" class="btn btn-primary" id="confirmBtn">{% trans "Yes, proceed" %}</button>
        </div>
      </div>
    </div>
</div>


<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", function(event) {

        const completed_btns = document.querySelectorAll('.btn-completed');
        const modal = new bootstrap.Modal(document.getElementById('confirmModal'));

        let confirmationTarget = false;
        let confirmationCaller = false;

        document.getElementById('confirmModal').addEventListener('hide.bs.modal', event => {

            confirmationTarget = false;
            confirmationCaller = false;

        });
        
        completed_btns.forEach(btn => {

            btn.addEventListener('click', event => {
                
                confirmationTarget = btn.getAttribute('data-course-id');
                confirmationCaller = btn;
                modal.show();
    
            });
        });

        document.getElementById('confirmBtn').addEventListener('click', event => {

            fetch("", {

                method: "POST",

                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token }}",
                },

                body: JSON.stringify({
                    course: confirmationTarget,
                }),

            })
            .then((response) => response.json())
            .then((json) => {

                if (json.result == "success"){
                    if (confirmationTarget === "all"){

                        completed_btns.forEach(btn => {

                            if (btn !== confirmationCaller){
                                btn.innerText = '{% trans "Course completed" %}';
                                btn.classList.add("disabled");
                            }

                        });

                    }
                    
                    else {

                        confirmationCaller.innerText = '{% trans "Course completed" %}';
                        confirmationCaller.classList.add("disabled");

                    }

                    modal.hide();
                }
            });

        });

    });
    
</script>